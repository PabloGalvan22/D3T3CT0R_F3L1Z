<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Bienestar - Detector de Felicidad y Positividad</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.0.2/wordcloud2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0d1f0f 0%, #1a2e1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #39ff14;
            text-align: center;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(57, 255, 20, 0.5);
            padding: 20px 0;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        h2, h3 {
            color: #39ff14;
            font-weight: 600;
            margin-top: 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid #39ff1433;
            padding-bottom: 10px;
        }

        h2 i, h3 i {
            margin-right: 10px;
        }

        .sidebar {
            background: linear-gradient(180deg, #1a2e1a 0%, #162e16 100%);
            border-right: 2px solid #39ff14;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: rgba(57, 255, 20, 0.08);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(57, 255, 20, 0.3);
            box-shadow: 0 4px 15px rgba(57, 255, 20, 0.15);
            text-align: center;
        }

        .metric-label {
            font-size: 1.1em;
            color: #a0a0a0;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #39ff14;
        }

        button {
            background: linear-gradient(90deg, #39ff14 0%, #28cc0d 100%);
            color: #0d1f0f;
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(57, 255, 20, 0.4);
            width: 100%;
            cursor: pointer;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(90deg, #28cc0d 0%, #39ff14 100%);
            box-shadow: 0 6px 20px rgba(57, 255, 20, 0.6);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-uploader {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 30px;
            border: 2px dashed #39ff14;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .file-uploader input {
            display: none;
        }

        .file-uploader i {
            font-size: 3em;
            color: #39ff14;
            margin-bottom: 15px;
        }

        select, .select-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px 20px;
            color: white;
            border: 1px solid #39ff14;
            width: 100%;
            margin: 10px 0 20px 0;
            cursor: pointer;
        }

        select option {
            background: #1a2e1a;
        }

        .info-box {
            background: rgba(57, 255, 20, 0.08);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #39ff14;
            margin: 20px 0;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .chart-container canvas {
            width: 100% !important;
            height: auto !important;
            min-height: 300px;
            max-height: 400px;
        }

        .wordcloud-wrapper {
            width: 100%;
            height: 400px;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        #wordcloud-canvas {
            width: 100%;
            height: 100%;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin: 30px 0;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.02);
        }

        th {
            background: #39ff1422;
            color: #39ff14;
            padding: 15px;
            font-weight: 600;
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #39ff1422;
        }

        /* Niveles de felicidad */
        .row-radiante   { background-color: #00b300 !important; color: white; }
        .row-muy-feliz  { background-color: #33cc00 !important; color: white; }
        .row-feliz      { background-color: #66cc33 !important; color: #0d1f0f; }
        .row-contento   { background-color: #99bb44 !important; color: #0d1f0f; }
        .row-neutro     { background-color: #444 !important; color: #ccc; }

        .spinner {
            border: 4px solid #39ff1422;
            border-top: 4px solid #39ff14;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            color: #a0a0a0;
            padding: 30px 0 20px;
            border-top: 2px solid #39ff1433;
            margin-top: 40px;
        }

        hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, transparent, #39ff14, transparent);
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
        }

        .text-highlight { color: #39ff14; font-weight: bold; }
        .text-secondary { color: #ffd700; font-weight: bold; }

        .caption {
            text-align: center;
            color: #a0a0a0;
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
<div class="app-container">

    <h1>üåü Monitor Bienestar: Detector de Felicidad</h1>
    <div style="text-align: center; color: #a0a0a0; font-size: 1.2em; margin-bottom: 30px;">
        Identifica mensajes con <span class="text-highlight">alegr√≠a, positividad y ganas de vivir</span>
        para saber qui√©n est√° <span class="text-secondary">bien</span>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <h3><i class="fas fa-file-upload"></i> Carga de Archivos</h3>
        <div class="file-uploader" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".csv,.xlsx,.txt">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Sube tu archivo (CSV, Excel, TXT)</p>
            <small style="color: #a0a0a0;">Haz clic para seleccionar</small>
        </div>

        <div id="columnSelectorContainer" style="display: none;">
            <label for="columnSelect">Selecciona columna de texto:</label>
            <select id="columnSelect" class="select-box"></select>
            <button onclick="analyzeFile()" id="analyzeBtn">
                <i class="fas fa-smile"></i> INICIAR AN√ÅLISIS DE BIENESTAR
            </button>
        </div>

        <div class="info-box" style="margin-top: 20px;">
            <h4 style="color: #39ff14; margin-bottom: 10px;">‚ÑπÔ∏è ¬øC√≥mo funciona?</h4>
            <p style="font-size: 0.9em;">El sistema punt√∫a cada mensaje seg√∫n palabras y frases de bienestar, alegr√≠a, motivaci√≥n y ganas de vivir. A mayor score, mayor se√±al de bienestar emocional.</p>
        </div>
    </div>

    <!-- Resultados -->
    <div id="resultsContainer" style="display: none;">
        <h2><i class="fas fa-chart-bar"></i> M√©tricas del An√°lisis</h2>
        <div class="metrics-container" id="metricsContainer"></div>

        <hr>

        <div class="charts-grid">
            <div class="chart-container">
                <h3><i class="fas fa-cloud"></i> Palabras de Bienestar Detectadas</h3>
                <div class="wordcloud-wrapper">
                    <canvas id="wordcloud-canvas"></canvas>
                </div>
                <p class="caption">T√©rminos m√°s usados en mensajes positivos (tama√±o = frecuencia)</p>
            </div>

            <div class="chart-container">
                <h3><i class="fas fa-chart-simple"></i> Palabras M√°s Usadas (Global)</h3>
                <canvas id="freqWordsChart"></canvas>
            </div>
        </div>

        <div class="chart-container" style="margin: 30px 0;">
            <h3><i class="fas fa-chart-pie"></i> Panorama General de Bienestar</h3>
            <canvas id="distributionChart"></canvas>
        </div>

        <h2><i class="fas fa-table"></i> Registro Detallado</h2>
        <div class="info-box" style="margin: 20px 0;">
            <i class="fas fa-info-circle"></i> Mostrando mensajes con indicadores de bienestar detectados, ordenados por score
        </div>
        <div class="table-container" id="tableContainer"></div>
    </div>

    <div id="loadingSpinner" class="spinner" style="display: none;"></div>

    <div class="footer">
        <p>Monitor Bienestar ‚Äî Sistema de Detecci√≥n de Positividad</p>
        <p style="font-size: 0.8em;">Desarrollado con ‚ù§Ô∏è para el cuidado emocional</p>
    </div>
</div>

<script>
    // =====================================================
    //  MOTOR DETECTOR DE FELICIDAD
    // =====================================================
    class DetectorBienestar {
        constructor() {
            // Palabras/frases positivas con su peso
            this.keywords = {
                // Expresiones de felicidad plena (peso alto)
                "estoy muy feliz": 10,
                "me siento feliz": 10,
                "soy muy feliz": 10,
                "me siento incre√≠ble": 10,
                "me siento increible": 10,
                "estoy incre√≠ble": 10,
                "estoy increible": 10,
                "estoy radiante": 10,
                "me siento radiante": 10,
                "lleno de vida": 10,
                "llena de vida": 10,
                "con muchas ganas de vivir": 10,
                "tengo muchas ganas de vivir": 10,
                "me encanta la vida": 10,
                "amo la vida": 10,
                "la vida es hermosa": 10,
                "la vida es bella": 10,
                "me alegra existir": 10,
                "qu√© afortunado soy": 9,
                "qu√© afortunada soy": 9,
                "que afortunado soy": 9,
                "que afortunada soy": 9,
                "me siento pleno": 9,
                "me siento plena": 9,
                "estoy muy bien": 9,
                "me siento muy bien": 9,
                "me siento genial": 9,
                "estoy genial": 9,
                "todo va bien": 8,
                "todo est√° yendo bien": 8,
                "todo esta yendo bien": 8,
                "me siento con energ√≠a": 8,
                "me siento con energia": 8,
                "tengo muchas ganas de": 7,
                "me emociona el futuro": 9,
                "tengo esperanza": 8,
                "estoy emocionado": 8,
                "estoy emocionada": 8,
                "me siento emocionado": 8,
                "me siento emocionada": 8,
                "estoy motivado": 8,
                "estoy motivada": 8,
                "me siento motivado": 8,
                "me siento motivada": 8,
                "con ganas de todo": 8,
                "lista para todo": 7,
                "listo para todo": 7,

                // Expresiones de alegr√≠a (peso medio-alto)
                "muy contento": 7,
                "muy contenta": 7,
                "estoy contento": 7,
                "estoy contenta": 7,
                "me siento contento": 7,
                "me siento contenta": 7,
                "s√∫per contento": 7,
                "super contento": 7,
                "me alegro": 6,
                "me alegra": 6,
                "qu√© alegr√≠a": 6,
                "que alegr√≠a": 6,
                "que alegria": 6,
                "qu√© alegria": 6,
                "muy alegre": 6,
                "estoy alegre": 6,
                "me siento alegre": 6,
                "tengo ganas de vivir": 8,
                "ganas de vivir": 7,
                "con ganas de vivir": 7,
                "quiero vivir": 7,
                "agradecido por vivir": 8,
                "agradecida por vivir": 8,
                "agradecido de vivir": 8,
                "agradecida de vivir": 8,
                "me alegra estar vivo": 9,
                "me alegra estar viva": 9,
                "qu√© bueno estar vivo": 9,
                "que bueno estar vivo": 9,

                // Amor, logros, proyectos (peso medio)
                "logr√© mis metas": 7,
                "logre mis metas": 7,
                "alcanc√© mi sue√±o": 7,
                "alcance mi sue√±o": 7,
                "cumpl√≠ mi sue√±o": 7,
                "cumpli mi sue√±o": 7,
                "logr√© mis objetivos": 7,
                "logre mis objetivos": 7,
                "me siento realizado": 7,
                "me siento realizada": 7,
                "estoy orgulloso": 6,
                "estoy orgullosa": 6,
                "me siento orgulloso": 6,
                "me siento orgullosa": 6,
                "estoy en paz": 6,
                "me siento en paz": 6,
                "tengo paz": 6,
                "me siento tranquilo": 5,
                "me siento tranquila": 5,
                "estoy tranquilo": 5,
                "estoy tranquila": 5,
                "me siento seguro": 5,
                "me siento segura": 5,
                "estoy seguro": 5,
                "estoy segura": 5,
                "me siento amado": 6,
                "me siento amada": 6,
                "me quieren": 6,
                "estoy rodeado de amor": 7,
                "estoy rodeada de amor": 7,
                "la gente me quiere": 6,
                "tengo personas que me quieren": 7,
                "mi familia me apoya": 7,
                "mis amigos me apoyan": 7,
                "me siento acompa√±ado": 6,
                "me siento acompa√±ada": 6,
                "no estoy solo": 6,
                "no estoy sola": 6,

                // Gratitud y esperanza (peso medio-bajo)
                "agradecido": 4,
                "agradecida": 4,
                "gracias por todo": 5,
                "gracias a la vida": 6,
                "qu√© hermoso d√≠a": 5,
                "que hermoso dia": 5,
                "hoy fue un gran d√≠a": 5,
                "hoy fue un gran dia": 5,
                "hoy fue un buen d√≠a": 5,
                "hoy fue un buen dia": 5,
                "fue un gran d√≠a": 5,
                "fue un buen d√≠a": 5,
                "pas√© un momento incre√≠ble": 6,
                "pase un momento increible": 6,
                "disfrut√© mucho": 5,
                "disfrute mucho": 5,
                "me divert√≠ mucho": 5,
                "me divert√≠ un mont√≥n": 5,
                "me divert√≠ much√≠simo": 6,
                "lo pas√© genial": 6,
                "lo pase genial": 6,
                "lo pas√© incre√≠ble": 6,
                "lo pase increible": 6,
                "me re√≠ mucho": 5,
                "me rei mucho": 5,
                "r√≠e mucho": 4,
                "jajaja": 3,
                "jajajaja": 3,
                "hahaha": 3,
                "jeje": 3,
                "tengo esperanza en el futuro": 7,
                "el futuro se ve bien": 6,
                "el futuro se ve prometedor": 7,
                "todo va a salir bien": 5,
                "saldr√© adelante": 5,
                "saldre adelante": 5,
                "voy a lograrlo": 5,
                "voy a superarlo": 5,
                "conf√≠o en m√≠": 6,
                "confio en mi": 6,
                "creo en m√≠": 6,
                "creo en mi": 6,
                "puedo con esto": 5,
                "puedo lograrlo": 5,
                "soy capaz": 5,

                // Palabras sueltas positivas (peso bajo)
                "feliz": 3,
                "alegre": 3,
                "contento": 3,
                "contenta": 3,
                "emocionado": 3,
                "emocionada": 3,
                "motivado": 3,
                "motivada": 3,
                "esperanza": 3,
                "ilusi√≥n": 3,
                "ilusion": 3,
                "entusiasmo": 3,
                "paz": 2,
                "tranquilo": 2,
                "tranquila": 2,
                "energ√≠a": 2,
                "energia": 2,
                "positivo": 2,
                "positiva": 2,
                "optimista": 3,
                "risas": 2,
                "risa": 2,
                "sonrisa": 2,
                "emoci√≥n": 2,
                "emocion": 2,
                "disfrutar": 2,
                "celebrar": 2,
                "celebraci√≥n": 3,
                "celebracion": 3,
                "logro": 2,
                "√©xito": 3,
                "exito": 3,
                "amor": 2,
                "cari√±o": 2,
                "carino": 2,
                "abrazo": 2,
                "amistad": 2,
                "gratitud": 3,
                "bendecido": 3,
                "bendecida": 3,
                "afortunado": 3,
                "afortunada": 3,
                "valoro": 2,
                "aprecio": 2,
                "agradezco": 3,

                // Negativos que anulan contexto (reducen score)
                "no estoy bien": -3,
                "no me siento bien": -3,
                "me siento mal": -3,
                "no hay salida": -5,
                "sin esperanza": -5,
                "todo es mentira": -4,
                "nada es real": -4,
                "ya no quiero": -4,
                "ya no puedo": -3,
                "no puedo m√°s": -3,
                "no puedo mas": -3,
            };

            // Palabras de contexto ir√≥nico/sarc√°stico que anulan el positivo
            this.ironicContext = [
                "iron√≠a", "ironia", "sarcasmo", "en broma", "broma", "jk", "joke",
                "nah en realidad", "mentira", "es mentira"
            ];
        }

        normalizarTexto(texto) {
            if (!texto || texto === null) return "";
            let t = String(texto).toLowerCase();
            t = t.replace(/¬§/g, "√±");
            t = t.replace(/¬°/g, "i");
            t = t.replace(/¬¢/g, "o");
            t = t.replace(/¬£/g, "u");
            t = t.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            return t;
        }

        analizarTexto(textoOriginal) {
            if (!textoOriginal || String(textoOriginal).trim() === "") {
                return { nivel: "Nulo", puntaje: 0, matches: [] };
            }

            const textoLimpio = this.normalizarTexto(textoOriginal);

            // Detectar contexto ir√≥nico
            let esIronico = false;
            for (let term of this.ironicContext) {
                if (textoLimpio.includes(this.normalizarTexto(term))) {
                    esIronico = true;
                    break;
                }
            }

            let puntaje = 0;
            let matches = [];

            for (let [word, peso] of Object.entries(this.keywords)) {
                const wordNorm = this.normalizarTexto(word);
                if (textoLimpio.includes(wordNorm)) {
                    // Si es ir√≥nico, las palabras positivas cuentan a la mitad
                    const pesoFinal = (esIronico && peso > 0) ? Math.floor(peso / 2) : peso;
                    puntaje += pesoFinal;
                    if (peso > 0) matches.push(word);
                }
            }

            if (puntaje < 0) puntaje = 0;

            let nivel;
            if (puntaje === 0) {
                nivel = "Neutro ‚Äî Sin se√±ales positivas";
            } else if (puntaje <= 3) {
                nivel = "Leve ‚Äî Tono ligeramente positivo";
            } else if (puntaje <= 7) {
                nivel = "Contento ‚Äî Bienestar moderado";
            } else if (puntaje <= 12) {
                nivel = "Feliz ‚Äî Buen estado emocional";
            } else if (puntaje <= 18) {
                nivel = "MUY FELIZ ‚Äî Alto bienestar";
            } else {
                nivel = "‚≠ê RADIANTE ‚Äî Bienestar excepcional";
            }

            return { nivel, puntaje, matches };
        }
    }

    // --- VARIABLES GLOBALES ---
    const detector = new DetectorBienestar();
    let fileData = null;
    let fileName = "";
    let results = [];

    // --- MANEJADOR DE ARCHIVOS ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        fileName = file.name;
        const reader = new FileReader();

        if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
            reader.onload = function(event) {
                parseTextFile(event.target.result, fileName);
            };
            reader.readAsText(file, 'utf-8');
        } else if (fileName.endsWith('.xlsx')) {
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                parseExcel(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }
    });

    function parseTextFile(text, fileName) {
        if (fileName.endsWith('.csv')) {
            const lines = text.split('\n').filter(l => l.trim() !== '');
            if (lines.length === 0) return;
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((h, idx) => row[h] = values[idx]);
                    data.push(row);
                }
            }
            fileData = data;
        } else {
            const lines = text.split('\n').filter(l => l.trim() !== '');
            fileData = lines.map((line, idx) => ({ 'Linea': line, 'ID': idx + 1 }));
        }
        showColumnSelector(fileData);
    }

    function parseExcel(rows) {
        if (rows.length === 0) return;
        const headers = rows[0];
        const data = [];
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (row.length === 0) continue;
            const rowObj = {};
            headers.forEach((h, idx) => { rowObj[h] = row[idx] !== undefined ? row[idx] : ''; });
            data.push(rowObj);
        }
        fileData = data;
        showColumnSelector(fileData);
    }

    function showColumnSelector(data) {
        if (!data || data.length === 0) return;
        const columns = Object.keys(data[0]);
        const select = document.getElementById('columnSelect');
        select.innerHTML = '';
        columns.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            select.appendChild(option);
        });
        document.getElementById('columnSelectorContainer').style.display = 'block';
    }

    // --- AN√ÅLISIS PRINCIPAL ---
    function analyzeFile() {
        if (!fileData) return;
        const column = document.getElementById('columnSelect').value;
        if (!column) return;

        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';

        setTimeout(() => {
            try {
                results = [];
                let allPositiveKeywords = [];

                fileData.forEach((row, index) => {
                    const text = row[column] || '';
                    const { nivel, puntaje, matches } = detector.analizarTexto(text);

                    if (String(text).trim() !== '') {
                        results.push({
                            ID: index + 1,
                            Texto: String(text).trim(),
                            Nivel: nivel,
                            Score: puntaje,
                            Detalles: matches.join(', ')
                        });

                        if (puntaje >= 4) {
                            matches.forEach(word => {
                                if (detector.keywords[word] >= 4) {
                                    allPositiveKeywords.push(word.replace(/ /g, '_'));
                                }
                            });
                        }
                    }
                });

                const conBienestar = results.filter(r => r.Score >= 4);
                const muyFelices  = results.filter(r => r.Nivel.includes('MUY FELIZ') || r.Nivel.includes('RADIANTE'));

                updateMetrics(results.length, conBienestar.length, muyFelices.length);

                if (allPositiveKeywords.length > 0) {
                    updateWordCloud(allPositiveKeywords);
                } else {
                    showNoWordCloud();
                }

                updateFreqWords(column);
                updateDistributionChart(results);
                updateTable(results);

                document.getElementById('resultsContainer').style.display = 'block';
            } catch (error) {
                alert('Error al analizar: ' + error.message);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }, 100);
    }

    // --- NUBE DE PALABRAS ---
    function updateWordCloud(keywords) {
        const canvas = document.getElementById('wordcloud-canvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const wordCount = {};
        keywords.forEach(w => wordCount[w] = (wordCount[w] || 0) + 1);
        const wordArray = Object.entries(wordCount).map(([word, count]) => [word, count]);

        const container = canvas.parentElement;
        canvas.width  = container.clientWidth  || 600;
        canvas.height = container.clientHeight || 400;

        const options = {
            list: wordArray,
            gridSize: 16,
            weightFactor: function(w) { return Math.pow(w, 0.8) * 20; },
            fontFamily: 'Arial, sans-serif',
            color: function() {
                // Verdes, amarillos y dorados
                const palette = ['#39ff14', '#ffd700', '#00e676', '#ffeb3b', '#69f0ae', '#c6ff00'];
                return palette[Math.floor(Math.random() * palette.length)];
            },
            rotateRatio: 0.3,
            rotationSteps: 2,
            backgroundColor: '#0d1f0f',
            minSize: 12,
            shape: 'circle',
            ellipticity: 0.7
        };

        try {
            if (WordCloud && canvas) WordCloud(canvas, options);
        } catch (e) {
            console.error('Error en wordcloud:', e);
            showNoWordCloud();
        }
    }

    function showNoWordCloud() {
        const canvas = document.getElementById('wordcloud-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = '20px Arial';
        ctx.fillStyle = '#a0a0a0';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('üòê No se detectaron palabras de bienestar', canvas.width / 2, canvas.height / 2);
    }

    // --- M√âTRICAS ---
    function updateMetrics(total, conBienestar, muyFelices) {
        const container = document.getElementById('metricsContainer');
        container.innerHTML = `
            <div class="metric-card">
                <div class="metric-label"><i class="fas fa-envelope"></i> Total Mensajes</div>
                <div class="metric-value">${total}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label"><i class="fas fa-smile"></i> Con se√±ales de bienestar</div>
                <div class="metric-value">${conBienestar}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label"><i class="fas fa-star"></i> Muy Felices / Radiantes</div>
                <div class="metric-value">${muyFelices}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label"><i class="fas fa-percentage"></i> % con bienestar</div>
                <div class="metric-value">${total > 0 ? Math.round((conBienestar / total) * 100) : 0}%</div>
            </div>
        `;
    }

    // --- FRECUENCIA DE PALABRAS ---
    function updateFreqWords(column) {
        let allText = fileData.map(row => row[column] || '').join(' ').toLowerCase();
        allText = allText.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        const words = allText.split(/\s+/);
        const stopwords = new Set(['de','la','que','el','en','y','a','los','se','del','las','un','por','con','no','una','su','para','es','al','lo','como','mas','pero','sus','le','ya','o','fue','este','ha','si','porque','esta','son','entre','cuando','muy','sin','sobre','tambien','me','hasta','hay','donde','quien','desde','todo','nos','durante','todos','uno','les','ni','contra','otros','ese','eso','ante','ellos','e','esto','mi','antes','algunos','unos','yo','otro','otras','otra','tanto','esa','estos','mucho','quienes','nada','muchos','cual','poco','ella','estar','estas','algunas','algo','nosotros','mis','tu','te','ti','tus','ellas','nosotras','vosotros','os','fui','fuiste','fue','fuimos','fuisteis','fueron','estoy','estamos','estan','he','has','han','hemos','soy','eres','somos','sois','era','eras','eramos','eran','tengo','tienes','tiene','tenemos','tienen']);

        const wordCount = {};
        words.forEach(word => {
            word = word.replace(/[^\w]/g, '');
            if (word && word.length > 2 && !stopwords.has(word)) {
                wordCount[word] = (wordCount[word] || 0) + 1;
            }
        });

        const sorted = Object.entries(wordCount).sort((a, b) => b[1] - a[1]).slice(0, 10);
        if (sorted.length === 0) return;

        const canvas = document.getElementById('freqWordsChart');
        const parent = canvas.parentNode;
        const newCanvas = document.createElement('canvas');
        newCanvas.id = 'freqWordsChart';
        parent.replaceChild(newCanvas, canvas);

        new Chart(newCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: sorted.map(item => item[0]),
                datasets: [{
                    label: 'Frecuencia',
                    data: sorted.map(item => item[1]),
                    backgroundColor: 'rgba(57, 255, 20, 0.6)',
                    borderColor: '#39ff14',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: { display: false } },
                scales: {
                    x: { grid: { color: '#39ff1422' }, ticks: { color: '#a0a0a0' } },
                    y: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                }
            }
        });
    }

    // --- GR√ÅFICO DISTRIBUCI√ìN ---
    function updateDistributionChart(results) {
        const levelCount = {};
        results.forEach(r => { levelCount[r.Nivel] = (levelCount[r.Nivel] || 0) + 1; });

        const labels = Object.keys(levelCount);
        const data   = Object.values(levelCount);

        const colors = labels.map(label => {
            if (label.includes('RADIANTE'))  return '#00b300';
            if (label.includes('MUY FELIZ')) return '#33cc00';
            if (label.includes('Feliz'))     return '#66cc33';
            if (label.includes('Contento'))  return '#99bb44';
            if (label.includes('Leve'))      return '#b8cc66';
            return '#555';
        });

        const canvas = document.getElementById('distributionChart');
        const parent = canvas.parentNode;
        const newCanvas = document.createElement('canvas');
        newCanvas.id = 'distributionChart';
        parent.replaceChild(newCanvas, canvas);

        new Chart(newCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{ data, backgroundColor: colors, borderColor: 'white', borderWidth: 1 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { anchor: 'end', align: 'top', color: 'white', font: { weight: 'bold' } }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#39ff1422' }, ticks: { color: '#a0a0a0' } },
                    x: { grid: { display: false }, ticks: { color: '#a0a0a0', maxRotation: 45 } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // --- TABLA ---
    function updateTable(results) {
        let filtered = results.filter(r => r.Score > 0);
        if (filtered.length === 0) filtered = results;
        filtered.sort((a, b) => b.Score - a.Score);

        let html = '<table><thead><tr><th>ID</th><th>Texto</th><th>Nivel</th><th>Score</th><th>Palabras detectadas</th></tr></thead><tbody>';

        filtered.forEach(row => {
            let rowClass = '';
            if (row.Nivel.includes('RADIANTE'))  rowClass = 'row-radiante';
            else if (row.Nivel.includes('MUY FELIZ')) rowClass = 'row-muy-feliz';
            else if (row.Nivel.includes('Feliz'))     rowClass = 'row-feliz';
            else if (row.Nivel.includes('Contento'))  rowClass = 'row-contento';
            else rowClass = 'row-neutro';

            html += `<tr class="${rowClass}">
                <td>${row.ID}</td>
                <td>${row.Texto.substring(0, 100)}${row.Texto.length > 100 ? '...' : ''}</td>
                <td>${row.Nivel}</td>
                <td>${row.Score}</td>
                <td>${row.Detalles}</td>
            </tr>`;
        });

        html += '</tbody></table>';
        document.getElementById('tableContainer').innerHTML = html;
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</body>
</html>